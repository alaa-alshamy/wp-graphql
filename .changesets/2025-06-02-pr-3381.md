---
title: "refactor: cleanup  class to reduce complexity and improve type safety"
pr: 3381
author: "justlevine"
type: "refactor"
breaking: false
---

## What does this implement/fix? Explain your changes.

This PR refactors the \`Model\` class to reduce code complexity and improve maintainability and DX. More specifically:

- \`Model::$data\` is now typed via a Generic type, instead of needlessly type-hinting in child classes.
   As a result, many doc types have been updated to use that generic instead of \`mixed\` or a lower-fidelity type.

- Splits the \`wrap_fields()\` method into several smaller functions (Single Responsibilities principle)

- **Fixes** the \`graphql_model_field_capability\` filter, so it runs on _all_ fields, not just those that are registered with a \`capability\` property. 
   This allows the filter to be used to add capability checks to existing fields, and not just to modify preset capabilities.

- Clarifies usage of various functions, specifically that \`setup()\` and \`tear_down()\` functions apply _per field_.

Files that rely on the \`Model\` class have been cleaned up accordingly.

### Developers Note

To correctly type the \`TData\` generic used by the \`Model\`, you can use the \`@extends\` syntax on the class doc-block:

For example if you are modeling data sourced from a custom \`WP_Post\` object:
\`\`\`php
{...}

use \WPGraphQL\Model\Model;

/**
 * {other class-docblock meta}
 *
 * @extends \WPGraphQL\Model\Model<\WP_Post>
 */
class EventCptModel extends Model { ... }
\`\`\`

## Does this close any currently open issues?



## Any other comments?


- \`AbstractDataLoader\` is using a \`@phpstan-type\` to centrally suppress the generic warning. In the future we can just swap that out with a \`@template\` or \`@extends\` without disrupting the rest of the file again.
